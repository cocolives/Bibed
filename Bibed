#!/usr/bin/env -S python -O
'''
Bibed — main application launcher
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Should installed or linked in :path:`/usr/bin`, or anywhere executable
programs live.

..  This file is part of the Bibed program.

    Bibed is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as
    published by the Free Software Foundation, version 3.

    Bibed is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public
    License version 3 along with Bibed. If not, see
    https://www.gnu.org/licenses/gpl-3.0.html

:copyright:
        * 2019 Olivier Cortès <olive@cocoliv.es>
        * 2019 Collectif Cocoliv.es <contact@cocoliv.es>

:license: GNU GPL version 3

'''

import sys
import time
import multiprocessing
import logging
import logging.handlers

from bibed.logging import setup_logging


LOGGER = logging.getLogger(__name__)


if __name__ == '__main__':
    time_start = time.time()

    # See app.py and daemon.py + spawn.py for the remaining.
    multiprocessing.set_start_method('spawn')
    multiprocessing.current_process().name = 'Bibed'

    if __debug__:
        logging_handlers = setup_logging(logging.DEBUG)
    else:
        logging_handlers = setup_logging(logging.INFO)

    from bibed.locale import _, init as locale_init
    locale_init()

    # Needs to be after setup_logging(),
    # else we miss a lot of message.
    from bibed.parallel import run_and_wait_on
    from bibed.dtu import seconds_to_string
    from bibed.gtk import Gtk  # NOQA
    from bibed.gui.splash import start_splash
    from bibed.app import BibedApplication
    from bibed.preferences import gpod
    from bibed.sentry import sentry

    splash = start_splash()

    if gpod('use_sentry'):
        splash.set_status(
            _('Connecting issue collector to {}…').format(
                gpod('sentry_url')))

        run_and_wait_on(sentry.enable)

        if __debug__:
            assert sentry.usable

            import sentry_sdk
            try:
                raise Exception('Test exception Bibed')

            except Exception:
                sentry_sdk.capture_exception()

        LOGGER.debug('Sentry startup time: {}'.format(
            seconds_to_string(time.time() - time_start)))

    app = BibedApplication(time_start=time_start, splash=splash,
                           logging_handlers=logging_handlers)

    exit_status = app.run(sys.argv)
    sys.exit(exit_status)
